---

#apache
- name: install apache
  apt: name=apache2 state=present

- name: create virtual host24
  template: src=apache/virtual_host24.j2
        dest=/etc/apache2/sites-available/{{ server_name_virtual_host }}.conf
        owner=root group=root mode=644 backup=yes
  when: ansible_distribution_release == "trusty"

- name: enable development site
  command: a2ensite {{ server_name_virtual_host }}.conf
  notify: restart apache

- name: create virtual host24 num 2
  template: src=apache/virtual_host24_2.j2
        dest=/etc/apache2/sites-available/{{ server_name_virtual_host_2 }}.conf
        owner=root group=root mode=644 backup=yes
  when: ansible_distribution_release == "trusty"

- name: enable development site
  command: a2ensite {{ server_name_virtual_host_2 }}.conf
  notify: restart apache

- name: create proxy vhost
  template: src=apache/proxy_vhost.j2
            dest=/etc/apache2/sites-available/proxy_vhost.conf
            owner=root
            group=root
            mode=644
            backup=yes
  when: ansible_distribution_release == "trusty"

- name: enable development site
  command: a2ensite proxy_vhost.conf
  notify: restart apache

#php55
- name: add php55 or php56 ppa
  apt_repository: repo=ppa:ondrej/php
  when: ansible_distribution_release == "trusty"

#apt update
- name: Update apt
  apt: update_cache=yes

- name: install PHP5 packages
  apt: name={{ item }} state=latest
  with_items:
    - php56
    - libapache2-mod-php5
    - php56-cli
    - php56-dev
    - php56-mysql
    - php-pear
    - php56-mcrypt
    - php56-gd
    - php56-curl
    - php56-xdebug
    - php56-memcache
    - php56-memcached
    - php56-readline
    - php56-sqlite
    - php56-common
    - php56-dev
    - php56-imagick
    - php56-intl
    - php56-xmlrpc

- file: path=/etc/php5/mods-available/custom.ini state=touch
- ini_file: dest=/etc/php5/mods-available/custom.ini
            section=Date
            option=date.timezone
            value=Europe/Rome
            backup=yes

- name: Enable custom.ini module
  command: php5enmod custom

- apache2_module: state=present name=php5
- apache2_module: state=present name=rewrite
- apache2_module: state=present name=env

- name: update apache env variables
  replace: dest=/etc/apache2/envvars regexp='www-data' replace='vagrant' backup=yes

- file: path=/var/lock/apache2 owner=vagrant group=vagrant
  notify: restart apache

- name: Install composer
  shell: chdir=/tmp creates=/tmp/composer.phar curl -sS https://getcomposer.org/installer | php

- name: Copy composer to bin dir
  shell: chdir=/tmp creates=/usr/bin/composer mv composer.phar /usr/bin/composer

- name: Make composer executable
  file: path=/usr/bin/composer owner=vagrant group=vagrant mode="0777"

- name: Install idephix
  get_url: url=http://getidephix.com/idephix.phar dest=/tmp/idephix.phar

- name: Copy idephix to bin dir
  command: chdir=/tmp creates=/usr/bin/idx mv idephix.phar /usr/bin/idx

- name: Make idephix executable
  file: path=/usr/bin/idx owner=vagrant group=vagrant mode="0777"

- name: Install php-cs-fixer
  shell: composer global require "fabpot/php-cs-fixer" --no-interaction chdir=/home/vagrant/
  sudo_user: vagrant

- name: Symlink php-cs-fixer to bin dir
  file: path=/usr/bin/php-cs-fixer state=link src=/home/vagrant/.composer/vendor/bin/php-cs-fixer

- name: Install phpmyadmin
  apt: pkg=phpmyadmin state=present

- name: Include phpmyadmin config file into Apache config file
  lineinfile: dest=/etc/apache2/apache2.conf line="Include /etc/phpmyadmin/apache.conf"
  notify: restart apache
